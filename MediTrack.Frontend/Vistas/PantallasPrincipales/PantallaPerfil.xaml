<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="MediTrack.Frontend.Vistas.PantallasPrincipales.PantallaPerfil"
    xmlns:base="clr-namespace:MediTrack.Frontend.Vistas.Base"
    BackgroundColor="#e6f0ff"
    Title="Perfil">

    <Grid>

        <!-- 1) Encabezado azul con patrón -->
        <Grid HeightRequest="150" VerticalOptions="Start">
            <BoxView Color="#3b71ff" Opacity="0.9" HorizontalOptions="Fill" VerticalOptions="Fill" />
            <Image Source="logo_patron.png" Aspect="AspectFill" Opacity="0.15" HorizontalOptions="Fill" VerticalOptions="Fill" />
        </Grid>

        <!-- 2) Contenedor blanco desplazable -->
        <ScrollView x:Name="MainScrollView" Margin="0,80,0,0" Scrolled="OnScrollViewScrolled">
            <Frame CornerRadius="40" Margin="0" Padding="25,80,25,25" BackgroundColor="White" HasShadow="False">
                <VerticalStackLayout Spacing="30">

                    <!-- Información Personal -->
                    <Frame BackgroundColor="#f8f9fa" CornerRadius="20" Padding="20" HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <!-- Header con título y botón editar -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Información Personal" FontAttributes="Bold" FontSize="18" TextColor="#0B2B6E" VerticalOptions="Center" Grid.Column="0" />
                                <Button x:Name="BtnEditarInfoPersonal" Grid.Column="1" BackgroundColor="#3b71ff" TextColor="White" CornerRadius="20" HeightRequest="35" WidthRequest="35" FontSize="18" Command="{Binding EditarInformacionPersonalCommand}" Clicked="OnEditInfoPersonalClicked">
                                    <Button.ImageSource>
                                        <FontImageSource Glyph="&#xE3C9;" FontFamily="MaterialIcons" Color="White" Size="18" />
                                    </Button.ImageSource>
                                </Button>
                            </Grid>

                            <!-- Información -->
                            <Grid ColumnDefinitions="140,*" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="15" RowSpacing="12">
                                <Label Text="Nombre Completo" Grid.Row="0" Grid.Column="0" TextColor="#495057" FontAttributes="Bold" FontSize="14" />
                                <Label Text="{Binding NombreCompleto}" Grid.Row="0" Grid.Column="1" TextColor="#212529" FontSize="14" />

                                <Label Text="Fecha de Nacimiento" Grid.Row="1" Grid.Column="0" TextColor="#495057" FontAttributes="Bold" FontSize="14" />
                                <Label Text="{Binding FechaNacimientoFormateada}" Grid.Row="1" Grid.Column="1" TextColor="#212529" FontSize="14" />

                                <Label Text="Género" Grid.Row="2" Grid.Column="0" TextColor="#495057" FontAttributes="Bold" FontSize="14" />
                                <Label Text="{Binding GeneroTexto}" Grid.Row="2" Grid.Column="1" TextColor="#212529" FontSize="14" />
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Información de Cuenta -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <Label Text="Información de Cuenta"
                                 FontAttributes="Bold"
                                 FontSize="18"
                                 TextColor="#0B2B6E" />

                            <Grid ColumnDefinitions="140,*"
                                RowDefinitions="Auto,Auto"
                                ColumnSpacing="15"
                                RowSpacing="12">
                                <Label Text="Correo" 
                                     Grid.Row="0" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Label Text="{Binding Usuario.email}" 
                                     Grid.Row="0" Grid.Column="1"
                                     TextColor="#212529"
                                     FontSize="14"/>

                                <Label Text="Estado de Cuenta" 
                                     Grid.Row="1" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Frame Grid.Row="1" Grid.Column="1"
                                     BackgroundColor="#d4edda"
                                     CornerRadius="12"
                                     Padding="8,4"
                                     HasShadow="False"
                                     HorizontalOptions="Start">
                                    <Label Text="{Binding EstadoCuenta}"
                                         TextColor="#155724"
                                         FontSize="12"
                                         FontAttributes="Bold"/>
                                </Frame>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Información Médica -->
                    <Label Text="Información Médica"
                         FontAttributes="Bold"
                         FontSize="20"
                         TextColor="#0B2B6E"
                         Margin="0,10,0,0" />

                    <!-- SECCIÓN DE CONDICIONES MÉDICAS - CORREGIDA -->
                    <Frame BackgroundColor="#f8f9fa" CornerRadius="20" Padding="20" HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Condiciones Médicas"
                                       FontAttributes="Bold"
                                       FontSize="16"
                                       TextColor="#0B2B6E"
                                       VerticalOptions="Center"
                                       Grid.Column="0" />
                                <Button x:Name="BtnEditarCondiciones"
                                        Grid.Column="1"
                                        BackgroundColor="#3b71ff"
                                        TextColor="White"
                                        CornerRadius="18"
                                        HeightRequest="36"
                                        WidthRequest="36"
                                        FontSize="18"
                                        Clicked="OnEditCondicionesMedicasClicked">
                                    <Button.ImageSource>
                                        <FontImageSource Glyph="&#xE3C9;" FontFamily="MaterialIcons" Color="White" Size="18" />
                                    </Button.ImageSource>
                                </Button>
                            </Grid>

                            <!-- Este botón ya no se usa con el modal, puedes eliminarlo -->
                            <Button x:Name="BtnAgregarCondicion"
                                    Text="+ Agregar Condición"
                                    BackgroundColor="#28a745"
                                    TextColor="White"
                                    CornerRadius="15"
                                    HeightRequest="40"
                                    FontSize="14"
                                    FontAttributes="Bold"
                                    IsVisible="False"
                                    Command="{Binding AgregarCondicionMedicaCommand}" />

                            <CollectionView ItemsSource="{Binding CondicionesMedicas}"
                                            SelectionMode="Multiple"
                                            SelectionChanged="OnCondicionesMedicasSeleccionadas"
                                            MinimumHeightRequest="80">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="0">
                                            <Frame BackgroundColor="White"
                                                   CornerRadius="15"
                                                   Padding="15,12"
                                                   HasShadow="True">
                                                <Grid ColumnDefinitions="Auto,*,Auto">
                                                    <Frame Grid.Column="0"
                                                           BackgroundColor="#3b71ff"
                                                           CornerRadius="12"
                                                           HeightRequest="24"
                                                           WidthRequest="24"
                                                           Padding="0"
                                                           HasShadow="False"
                                                           VerticalOptions="Center"
                                                           Margin="0,0,10,0">
                                                        <Image HorizontalOptions="Center"
                                                               VerticalOptions="Center">
                                                            <Image.Source>
                                                                <FontImageSource Glyph="&#xE8F4;" FontFamily="MaterialIcons" Color="White" Size="14"/>
                                                            </Image.Source>
                                                        </Image>
                                                    </Frame>
                                                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                                                        <Label Text="{Binding nombre_condicion}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="#212529"/>
                                                        <Label Text="{Binding descripcion}"
                                                               FontSize="11"
                                                               TextColor="#6c757d"/>
                                                    </StackLayout>
                                                </Grid>
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <StackLayout Padding="20" Spacing="10">
                                        <Image HorizontalOptions="Center">
                                            <Image.Source>
                                                <FontImageSource Glyph="&#xE8F4;" FontFamily="MaterialIcons" Color="#adb5bd" Size="40"/>
                                            </Image.Source>
                                        </Image>
                                        <!-- CORREGIDO: Texto correcto para condiciones médicas -->
                                        <Label Text="No hay condiciones médicas registradas"
                                               TextColor="#6c757d"
                                               FontAttributes="Italic"
                                               HorizontalOptions="Center"
                                               FontSize="14"/>
                                    </StackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- SECCIÓN DE ALERGIAS - CORREGIDA -->
                    <Frame BackgroundColor="#f8f9fa" CornerRadius="20" Padding="20" HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Alergias"
                                       FontAttributes="Bold"
                                       FontSize="16"
                                       TextColor="#0B2B6E"
                                       VerticalOptions="Center"
                                       Grid.Column="0" />
                                <Button x:Name="BtnEditarAlergias"
                                        Grid.Column="1"
                                        BackgroundColor="#3b71ff"
                                        TextColor="White"
                                        CornerRadius="18"
                                        HeightRequest="36"
                                        WidthRequest="36"
                                        FontSize="18"
                                        Clicked="OnEditAlergiasClicked">
                                    <Button.ImageSource>
                                        <FontImageSource Glyph="&#xE3C9;" FontFamily="MaterialIcons" Color="White" Size="18" />
                                    </Button.ImageSource>
                                </Button>
                            </Grid>

                            <!-- CORREGIDO: Nombre consistente del botón -->
                            <Button x:Name="BtnAgregarAlergia"
                                    Text="+ Agregar Alergia"
                                    BackgroundColor="#28a745"
                                    TextColor="White"
                                    CornerRadius="15"
                                    HeightRequest="40"
                                    FontSize="14"
                                    FontAttributes="Bold"
                                    IsVisible="False"
                                    Command="{Binding ToggleMostrarFormularioNuevaAlergiaCommand}" />

                            <CollectionView ItemsSource="{Binding Alergias}"
                                            SelectionMode="Multiple"
                                            SelectionChanged="OnAlergiasSeleccionadas"
                                            MinimumHeightRequest="80">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="0">
                                            <Frame BackgroundColor="White"
                                                   CornerRadius="15"
                                                   Padding="15,12"
                                                   HasShadow="True">
                                                <Grid ColumnDefinitions="Auto,*,Auto">
                                                    <Frame Grid.Column="0"
                                                           BackgroundColor="#3b71ff"
                                                           CornerRadius="12"
                                                           HeightRequest="24"
                                                           WidthRequest="24"
                                                           Padding="0"
                                                           HasShadow="False"
                                                           VerticalOptions="Center"
                                                           Margin="0,0,10,0">
                                                        <Image HorizontalOptions="Center"
                                                               VerticalOptions="Center">
                                                            <Image.Source>
                                                                <FontImageSource Glyph="&#xE8F4;" FontFamily="MaterialIcons" Color="White" Size="14"/>
                                                            </Image.Source>
                                                        </Image>
                                                    </Frame>
                                                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                                                        <Label Text="{Binding nombre_alergia}"
                                                               FontSize="14"
                                                               FontAttributes="Bold"
                                                               TextColor="#212529"/>
                                                        <Label Text="{Binding descripcion}"
                                                               FontSize="11"
                                                               TextColor="#6c757d"/>
                                                    </StackLayout>
                                                </Grid>
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <StackLayout Padding="20" Spacing="10">
                                        <Image HorizontalOptions="Center">
                                            <Image.Source>
                                                <FontImageSource Glyph="&#xE8F4;" FontFamily="MaterialIcons" Color="#adb5bd" Size="40"/>
                                            </Image.Source>
                                        </Image>
                                        <Label Text="No hay alergias registradas"
                                               TextColor="#6c757d"
                                               FontAttributes="Italic"
                                               HorizontalOptions="Center"
                                               FontSize="14"/>
                                    </StackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Botón Cerrar Sesión -->
                    <Frame BackgroundColor="#dc3545" CornerRadius="25" Padding="0" HasShadow="True" Margin="0,20,0,0">
                        <Button Text="Cerrar Sesión" BackgroundColor="Transparent" TextColor="White" CornerRadius="25" HeightRequest="50" FontSize="16" FontAttributes="Bold" HorizontalOptions="Fill" Command="{Binding CerrarSesionCommand}">
                        </Button>
                    </Frame>

                </VerticalStackLayout>
            </Frame>
        </ScrollView>

        <Grid x:Name="AvatarContainer" HorizontalOptions="Center" VerticalOptions="Start" Margin="0,30,0,0">
            <Frame BackgroundColor="White" CornerRadius="60" HeightRequest="120" WidthRequest="120" Padding="15" HasShadow="True">
                <Image>
                    <Image.Source>
                        <FontImageSource Glyph="&#xE853;" FontFamily="MaterialIcons" Color="#3b71ff" Size="90" />
                    </Image.Source>
                </Image>
            </Frame>
        </Grid>

        <!-- Indicador de carga -->
        <Grid IsVisible="{Binding IsBusy}" BackgroundColor="#80000000" HorizontalOptions="Fill" VerticalOptions="Fill">
            <Frame BackgroundColor="White" CornerRadius="20" Padding="30" HorizontalOptions="Center" VerticalOptions="Center" HasShadow="True">
                <StackLayout Orientation="Horizontal" Spacing="20">
                    <ActivityIndicator IsRunning="True" Color="#3b71ff" HeightRequest="30" WidthRequest="30" />
                    <Label Text="Cargando perfil..." TextColor="#0B2B6E" VerticalOptions="Center" FontSize="16" />
                </StackLayout>
            </Frame>
        </Grid>

    </Grid>
</base:BaseContentPage>