<?xml version="1.0" encoding="utf-8" ?>
<base:BaseContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    x:Class="MediTrack.Frontend.Vistas.PantallasPrincipales.PantallaPerfil"
    xmlns:base="clr-namespace:MediTrack.Frontend.Vistas"
    BackgroundColor="#e6f0ff"
    Title="Perfil">

    <Grid>

        <!-- 1) Encabezado azul con patrón -->
        <Grid HeightRequest="150"
          VerticalOptions="Start">
            <BoxView Color="#3b71ff"
               Opacity="0.9"
               HorizontalOptions="Fill"
               VerticalOptions="Fill" />
            <Image Source="logo_patron.png"
             Aspect="AspectFill"
             Opacity="0.15"
             HorizontalOptions="Fill"
             VerticalOptions="Fill" />
        </Grid>

        <!-- 2) Contenedor blanco desplazable -->
        <ScrollView Margin="0,80,0,0">
            <Frame CornerRadius="40"
             Margin="0"
             Padding="25,80,25,25"
             BackgroundColor="White"
             HasShadow="False">

                <VerticalStackLayout Spacing="30">

                    <!-- Información Personal -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <!-- Header con título y botón editar -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Información Personal"
                                     FontAttributes="Bold"
                                     FontSize="18"
                                     TextColor="#0B2B6E"
                                     VerticalOptions="Center"
                                     Grid.Column="0" />
                                <Button Grid.Column="1"
                                      Text="&#xE3C9;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#3b71ff"
                                      TextColor="White"
                                      CornerRadius="20"
                                      HeightRequest="35"
                                      WidthRequest="35"
                                      FontSize="18"
                                      Command="{Binding EditarInformacionPersonalCommand}" />
                            </Grid>

                            <!-- Información -->
                            <Grid ColumnDefinitions="140,*"
                                RowDefinitions="Auto,Auto,Auto"
                                ColumnSpacing="15"
                                RowSpacing="12">
                                <Label Text="Nombre Completo" 
                                     Grid.Row="0" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Label Text="{Binding NombreCompleto}" 
                                     Grid.Row="0" Grid.Column="1"
                                     TextColor="#212529"
                                     FontSize="14"/>

                                <Label Text="Fecha de Nacimiento" 
                                     Grid.Row="1" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Label Text="{Binding FechaNacimientoFormateada}" 
                                     Grid.Row="1" Grid.Column="1"
                                     TextColor="#212529"
                                     FontSize="14"/>

                                <Label Text="Género" 
                                     Grid.Row="2" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Label Text="{Binding GeneroTexto}" 
                                     Grid.Row="2" Grid.Column="1"
                                     TextColor="#212529"
                                     FontSize="14"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Información de Cuenta -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <Label Text="Información de Cuenta"
                                 FontAttributes="Bold"
                                 FontSize="18"
                                 TextColor="#0B2B6E" />

                            <Grid ColumnDefinitions="140,*"
                                RowDefinitions="Auto,Auto"
                                ColumnSpacing="15"
                                RowSpacing="12">
                                <Label Text="Correo" 
                                     Grid.Row="0" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Label Text="{Binding Usuario.email}" 
                                     Grid.Row="0" Grid.Column="1"
                                     TextColor="#212529"
                                     FontSize="14"/>

                                <Label Text="Estado de Cuenta" 
                                     Grid.Row="1" Grid.Column="0" 
                                     TextColor="#495057"
                                     FontAttributes="Bold"
                                     FontSize="14"/>
                                <Frame Grid.Row="1" Grid.Column="1"
                                     BackgroundColor="#d4edda"
                                     CornerRadius="12"
                                     Padding="8,4"
                                     HasShadow="False"
                                     HorizontalOptions="Start">
                                    <Label Text="{Binding EstadoCuenta}"
                                         TextColor="#155724"
                                         FontSize="12"
                                         FontAttributes="Bold"/>
                                </Frame>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Configuración -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <!-- Header con título y botón editar -->
                            <Grid ColumnDefinitions="*,Auto">
                                <Label Text="Configuración"
                                     FontAttributes="Bold"
                                     FontSize="18"
                                     TextColor="#0B2B6E"
                                     VerticalOptions="Center"
                                     Grid.Column="0" />
                                <Button Grid.Column="1"
                                      Text="&#xE8B8;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#3b71ff"
                                      TextColor="White"
                                      CornerRadius="20"
                                      HeightRequest="35"
                                      WidthRequest="35"
                                      FontSize="18"
                                      Command="{Binding EditarConfiguracionCommand}" />
                            </Grid>

                            <Grid ColumnDefinitions="*,Auto"
                                RowDefinitions="Auto"
                                ColumnSpacing="15">
                                <StackLayout Grid.Column="0" Spacing="5">
                                    <Label Text="Notificaciones Push" 
                                         TextColor="#495057"
                                         FontAttributes="Bold"
                                         FontSize="14"/>
                                    <Label Text="Recibir alertas de medicamentos" 
                                         TextColor="#6c757d"
                                         FontSize="12"/>
                                </StackLayout>
                                <Switch Grid.Column="1" 
                                      IsToggled="{Binding Usuario.notificaciones_push}"
                                      OnColor="#3b71ff"
                                      ThumbColor="White"
                                      Toggled="OnNotificacionesToggled"
                                      VerticalOptions="Center"/>
                            </Grid>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Información Médica -->
                    <Label Text="Información Médica"
                         FontAttributes="Bold"
                         FontSize="20"
                         TextColor="#0B2B6E"
                         Margin="0,10,0,0" />

                    <!-- Condiciones Médicas -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <!-- Header con título y botones -->
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <Label Text="Condiciones Médicas"
                                     FontAttributes="Bold"
                                     FontSize="16"
                                     TextColor="#0B2B6E"
                                     VerticalOptions="Center"
                                     Grid.Column="0" />
                                <Button Grid.Column="1"
                                      Text="&#xE145;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#28a745"
                                      TextColor="White"
                                      CornerRadius="18"
                                      HeightRequest="36"
                                      WidthRequest="36"
                                      FontSize="20"
                                      Margin="0,0,8,0"
                                      Command="{Binding AgregarCondicionMedicaCommand}" />
                                <Button Grid.Column="2"
                                      Text="&#xE3C9;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#3b71ff"
                                      TextColor="White"
                                      CornerRadius="18"
                                      HeightRequest="36"
                                      WidthRequest="36"
                                      FontSize="18"
                                      Command="{Binding EditarCondicionesMedicasCommand}" />
                            </Grid>

                            <!-- Lista de Condiciones -->
                            <CollectionView ItemsSource="{Binding CondicionesMedicas}"
                                  SelectionMode="Multiple"
                                  SelectionChanged="OnCondicionesMedicasSeleccionadas"
                                  MinimumHeightRequest="80">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="0">
                                            <Frame BackgroundColor="White"
                                                 CornerRadius="15"
                                                 Padding="15,12"
                                                 HasShadow="True">
                                                <Grid ColumnDefinitions="Auto,*">
                                                    <Frame Grid.Column="0"
                                                         BackgroundColor="#3b71ff"
                                                         CornerRadius="12"
                                                         HeightRequest="24"
                                                         WidthRequest="24"
                                                         Padding="0"
                                                         HasShadow="False"
                                                         VerticalOptions="Center"
                                                         Margin="0,0,10,0">
                                                        <Label FontFamily="MaterialIcons"
                                                             Text="&#xE8F4;"
                                                             FontSize="14"
                                                             TextColor="White"
                                                             HorizontalOptions="Center"
                                                             VerticalOptions="Center"/>
                                                    </Frame>
                                                    <Label Grid.Column="1"
                                                         Text="{Binding nombre_condicion}"
                                                         FontSize="14"
                                                         TextColor="#212529"
                                                         VerticalOptions="Center" />
                                                </Grid>
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <StackLayout Padding="20" Spacing="10">
                                        <Label FontFamily="MaterialIcons"
                                             Text="&#xE8F4;"
                                             FontSize="40"
                                             TextColor="#adb5bd"
                                             HorizontalOptions="Center"/>
                                        <Label Text="No hay condiciones médicas registradas"
                                             TextColor="#6c757d"
                                             FontAttributes="Italic"
                                             HorizontalOptions="Center"
                                             FontSize="14"/>
                                    </StackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>

                    <!-- Alergias -->
                    <Frame BackgroundColor="#f8f9fa" 
                           CornerRadius="20" 
                           Padding="20" 
                           HasShadow="True">
                        <VerticalStackLayout Spacing="15">
                            <!-- Header con título y botones -->
                            <Grid ColumnDefinitions="*,Auto,Auto">
                                <Label Text="Alergias"
                                     FontAttributes="Bold"
                                     FontSize="16"
                                     TextColor="#0B2B6E"
                                     VerticalOptions="Center"
                                     Grid.Column="0" />
                                <Button Grid.Column="1"
                                      Text="&#xE145;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#dc3545"
                                      TextColor="White"
                                      CornerRadius="18"
                                      HeightRequest="36"
                                      WidthRequest="36"
                                      FontSize="20"
                                      Margin="0,0,8,0"
                                      Command="{Binding AgregarAlergiaCommand}" />
                                <Button Grid.Column="2"
                                      Text="&#xE3C9;"
                                      FontFamily="MaterialIcons"
                                      BackgroundColor="#dc3545"
                                      TextColor="White"
                                      CornerRadius="18"
                                      HeightRequest="36"
                                      WidthRequest="36"
                                      FontSize="18"
                                      Command="{Binding EditarAlergiasCommand}" />
                            </Grid>

                            <!-- Lista de Alergias -->
                            <CollectionView ItemsSource="{Binding Alergias}"
                                  SelectionMode="Multiple"
                                  SelectionChanged="OnAlergiasSeleccionadas"
                                  MinimumHeightRequest="80">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="8"/>
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Grid Padding="0">
                                            <Frame BackgroundColor="White"
                                                 CornerRadius="15"
                                                 Padding="15,12"
                                                 HasShadow="True">
                                                <Grid ColumnDefinitions="Auto,*">
                                                    <Frame Grid.Column="0"
                                                         BackgroundColor="#dc3545"
                                                         CornerRadius="12"
                                                         HeightRequest="24"
                                                         WidthRequest="24"
                                                         Padding="0"
                                                         HasShadow="False"
                                                         VerticalOptions="Center"
                                                         Margin="0,0,10,0">
                                                        <Label FontFamily="MaterialIcons"
                                                             Text="&#xE000;"
                                                             FontSize="14"
                                                             TextColor="White"
                                                             HorizontalOptions="Center"
                                                             VerticalOptions="Center"/>
                                                    </Frame>
                                                    <Label Grid.Column="1"
                                                         Text="{Binding nombre_alergia}"
                                                         FontSize="14"
                                                         TextColor="#721c24"
                                                         VerticalOptions="Center" />
                                                </Grid>
                                            </Frame>
                                        </Grid>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                                <CollectionView.EmptyView>
                                    <StackLayout Padding="20" Spacing="10">
                                        <Label FontFamily="MaterialIcons"
                                             Text="&#xE000;"
                                             FontSize="40"
                                             TextColor="#adb5bd"
                                             HorizontalOptions="Center"/>
                                        <Label Text="No hay alergias registradas"
                                             TextColor="#6c757d"
                                             FontAttributes="Italic"
                                             HorizontalOptions="Center"
                                             FontSize="14"/>
                                    </StackLayout>
                                </CollectionView.EmptyView>
                            </CollectionView>
                        </VerticalStackLayout>
                    </Frame>


                        <Button Text="🚪  Cerrar Sesión"
                              BackgroundColor="White"
                              TextColor="#dc3545"
                              CornerRadius="25"
                              HeightRequest="50"
                              FontSize="16"
                              FontAttributes="Bold"
                              HorizontalOptions="Fill"
                              Command="{Binding CerrarSesionCommand}" />


                </VerticalStackLayout>
            </Frame>
        </ScrollView>

        <!-- 3) Avatar para la foto de perfil -->
        <Grid HorizontalOptions="Center"
          VerticalOptions="Start"
          Margin="0,30,0,0">
            <Frame BackgroundColor="White"
             CornerRadius="60"
             HeightRequest="120"
             WidthRequest="120"
             Padding="15"
             HasShadow="True">
                <Label FontFamily="MaterialIcons"
               Text="&#xE853;"
               FontSize="90"
               TextColor="#3b71ff"
               HorizontalOptions="Center"
               VerticalOptions="Center"/>
            </Frame>
            <Frame Padding="0"
             WidthRequest="32"
             HeightRequest="32"
             BackgroundColor="#28a745"
             CornerRadius="16"
             HorizontalOptions="End"
             VerticalOptions="End"
             Margin="0,0,-10,-10"
             HasShadow="True">
                <Label Text="✏️"
               FontSize="16"
               TextColor="White"
               HorizontalOptions="Center"
               VerticalOptions="Center"/>
            </Frame>
        </Grid>

        <!-- Indicador de carga -->
        <Grid IsVisible="{Binding IsBusy}"
              BackgroundColor="#80000000"
              HorizontalOptions="Fill"
              VerticalOptions="Fill">
            <Frame BackgroundColor="White"
                   CornerRadius="20"
                   Padding="30"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"
                   HasShadow="True">
                <StackLayout Orientation="Horizontal" Spacing="20">
                    <ActivityIndicator IsRunning="True" 
                                     Color="#3b71ff"
                                     HeightRequest="30"
                                     WidthRequest="30"/>
                    <Label Text="Cargando perfil..." 
                         TextColor="#0B2B6E" 
                         VerticalOptions="Center"
                         FontSize="16"/>
                </StackLayout>
            </Frame>
        </Grid>

    </Grid>
</base:BaseContentPage>